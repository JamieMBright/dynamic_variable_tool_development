function MERRA2extraction(MERRA2_vars,MERRA2_raw_process,MERRA2_prefix,years,y,store)
% Vars from MERRA2
% lats and lons
lats=[-90;-89.5000000000000;-89;-88.5000000000000;-88;-87.5000000000000;-87;-86.5000000000000;-86;-85.5000000000000;-85;-84.5000000000000;-84;-83.5000000000000;-83;-82.5000000000000;-82;-81.5000000000000;-81;-80.5000000000000;-80;-79.5000000000000;-79;-78.5000000000000;-78;-77.5000000000000;-77;-76.5000000000000;-76;-75.5000000000000;-75;-74.5000000000000;-74;-73.5000000000000;-73;-72.5000000000000;-72;-71.5000000000000;-71;-70.5000000000000;-70;-69.5000000000000;-69;-68.5000000000000;-68;-67.5000000000000;-67;-66.5000000000000;-66;-65.5000000000000;-65;-64.5000000000000;-64;-63.5000000000000;-63;-62.5000000000000;-62;-61.5000000000000;-61;-60.5000000000000;-60;-59.5000000000000;-59;-58.5000000000000;-58;-57.5000000000000;-57;-56.5000000000000;-56;-55.5000000000000;-55;-54.5000000000000;-54;-53.5000000000000;-53;-52.5000000000000;-52;-51.5000000000000;-51;-50.5000000000000;-50;-49.5000000000000;-49;-48.5000000000000;-48;-47.5000000000000;-47;-46.5000000000000;-46;-45.5000000000000;-45;-44.5000000000000;-44;-43.5000000000000;-43;-42.5000000000000;-42;-41.5000000000000;-41;-40.5000000000000;-40;-39.5000000000000;-39;-38.5000000000000;-38;-37.5000000000000;-37;-36.5000000000000;-36;-35.5000000000000;-35;-34.5000000000000;-34;-33.5000000000000;-33;-32.5000000000000;-32;-31.5000000000000;-31;-30.5000000000000;-30;-29.5000000000000;-29;-28.5000000000000;-28;-27.5000000000000;-27;-26.5000000000000;-26;-25.5000000000000;-25;-24.5000000000000;-24;-23.5000000000000;-23;-22.5000000000000;-22;-21.5000000000000;-21;-20.5000000000000;-20;-19.5000000000000;-19;-18.5000000000000;-18;-17.5000000000000;-17;-16.5000000000000;-16;-15.5000000000000;-15;-14.5000000000000;-14;-13.5000000000000;-13;-12.5000000000000;-12;-11.5000000000000;-11;-10.5000000000000;-10;-9.50000000000000;-9;-8.50000000000000;-8;-7.50000000000000;-7;-6.50000000000000;-6;-5.50000000000000;-5;-4.50000000000000;-4;-3.50000000000000;-3;-2.50000000000000;-2;-1.50000000000000;-1;-0.500000000000000;-1.79751030141180e-13;0.500000000000000;1;1.50000000000000;2;2.50000000000000;3;3.50000000000000;4;4.50000000000000;5;5.50000000000000;6;6.50000000000000;7;7.50000000000000;8;8.50000000000000;9;9.50000000000000;10;10.5000000000000;11;11.5000000000000;12;12.5000000000000;13;13.5000000000000;14;14.5000000000000;15;15.5000000000000;16;16.5000000000000;17;17.5000000000000;18;18.5000000000000;19;19.5000000000000;20;20.5000000000000;21;21.5000000000000;22;22.5000000000000;23;23.5000000000000;24;24.5000000000000;25;25.5000000000000;26;26.5000000000000;27;27.5000000000000;28;28.5000000000000;29;29.5000000000000;30;30.5000000000000;31;31.5000000000000;32;32.5000000000000;33;33.5000000000000;34;34.5000000000000;35;35.5000000000000;36;36.5000000000000;37;37.5000000000000;38;38.5000000000000;39;39.5000000000000;40;40.5000000000000;41;41.5000000000000;42;42.5000000000000;43;43.5000000000000;44;44.5000000000000;45;45.5000000000000;46;46.5000000000000;47;47.5000000000000;48;48.5000000000000;49;49.5000000000000;50;50.5000000000000;51;51.5000000000000;52;52.5000000000000;53;53.5000000000000;54;54.5000000000000;55;55.5000000000000;56;56.5000000000000;57;57.5000000000000;58;58.5000000000000;59;59.5000000000000;60;60.5000000000000;61;61.5000000000000;62;62.5000000000000;63;63.5000000000000;64;64.5000000000000;65;65.5000000000000;66;66.5000000000000;67;67.5000000000000;68;68.5000000000000;69;69.5000000000000;70;70.5000000000000;71;71.5000000000000;72;72.5000000000000;73;73.5000000000000;74;74.5000000000000;75;75.5000000000000;76;76.5000000000000;77;77.5000000000000;78;78.5000000000000;79;79.5000000000000;80;80.5000000000000;81;81.5000000000000;82;82.5000000000000;83;83.5000000000000;84;84.5000000000000;85;85.5000000000000;86;86.5000000000000;87;87.5000000000000;88;88.5000000000000;89;89.5000000000000;90];
lons=[-180;-179.375000000000;-178.750000000000;-178.125000000000;-177.500000000000;-176.875000000000;-176.250000000000;-175.625000000000;-175;-174.375000000000;-173.750000000000;-173.125000000000;-172.500000000000;-171.875000000000;-171.250000000000;-170.625000000000;-170;-169.375000000000;-168.750000000000;-168.125000000000;-167.500000000000;-166.875000000000;-166.250000000000;-165.625000000000;-165;-164.375000000000;-163.750000000000;-163.125000000000;-162.500000000000;-161.875000000000;-161.250000000000;-160.625000000000;-160;-159.375000000000;-158.750000000000;-158.125000000000;-157.500000000000;-156.875000000000;-156.250000000000;-155.625000000000;-155;-154.375000000000;-153.750000000000;-153.125000000000;-152.500000000000;-151.875000000000;-151.250000000000;-150.625000000000;-150;-149.375000000000;-148.750000000000;-148.125000000000;-147.500000000000;-146.875000000000;-146.250000000000;-145.625000000000;-145;-144.375000000000;-143.750000000000;-143.125000000000;-142.500000000000;-141.875000000000;-141.250000000000;-140.625000000000;-140;-139.375000000000;-138.750000000000;-138.125000000000;-137.500000000000;-136.875000000000;-136.250000000000;-135.625000000000;-135;-134.375000000000;-133.750000000000;-133.125000000000;-132.500000000000;-131.875000000000;-131.250000000000;-130.625000000000;-130;-129.375000000000;-128.750000000000;-128.125000000000;-127.500000000000;-126.875000000000;-126.250000000000;-125.625000000000;-125;-124.375000000000;-123.750000000000;-123.125000000000;-122.500000000000;-121.875000000000;-121.250000000000;-120.625000000000;-120;-119.375000000000;-118.750000000000;-118.125000000000;-117.500000000000;-116.875000000000;-116.250000000000;-115.625000000000;-115;-114.375000000000;-113.750000000000;-113.125000000000;-112.500000000000;-111.875000000000;-111.250000000000;-110.625000000000;-110;-109.375000000000;-108.750000000000;-108.125000000000;-107.500000000000;-106.875000000000;-106.250000000000;-105.625000000000;-105;-104.375000000000;-103.750000000000;-103.125000000000;-102.500000000000;-101.875000000000;-101.250000000000;-100.625000000000;-100;-99.3750000000000;-98.7500000000000;-98.1250000000000;-97.5000000000000;-96.8750000000000;-96.2500000000000;-95.6250000000000;-95;-94.3750000000000;-93.7500000000000;-93.1250000000000;-92.5000000000000;-91.8750000000000;-91.2500000000000;-90.6250000000000;-90;-89.3750000000000;-88.7500000000000;-88.1250000000000;-87.5000000000000;-86.8750000000000;-86.2500000000000;-85.6250000000000;-85;-84.3750000000000;-83.7500000000000;-83.1250000000000;-82.5000000000000;-81.8750000000000;-81.2500000000000;-80.6250000000000;-80;-79.3750000000000;-78.7500000000000;-78.1250000000000;-77.5000000000000;-76.8750000000000;-76.2500000000000;-75.6250000000000;-75;-74.3750000000000;-73.7500000000000;-73.1250000000000;-72.5000000000000;-71.8750000000000;-71.2500000000000;-70.6250000000000;-70;-69.3750000000000;-68.7500000000000;-68.1250000000000;-67.5000000000000;-66.8750000000000;-66.2500000000000;-65.6250000000000;-65;-64.3750000000000;-63.7500000000000;-63.1250000000000;-62.5000000000000;-61.8750000000000;-61.2500000000000;-60.6250000000000;-60;-59.3750000000000;-58.7500000000000;-58.1250000000000;-57.5000000000000;-56.8750000000000;-56.2500000000000;-55.6250000000000;-55;-54.3750000000000;-53.7500000000000;-53.1250000000000;-52.5000000000000;-51.8750000000000;-51.2500000000000;-50.6250000000000;-50;-49.3750000000000;-48.7500000000000;-48.1250000000000;-47.5000000000000;-46.8750000000000;-46.2500000000000;-45.6250000000000;-45;-44.3750000000000;-43.7500000000000;-43.1250000000000;-42.5000000000000;-41.8750000000000;-41.2500000000000;-40.6250000000000;-40;-39.3750000000000;-38.7500000000000;-38.1250000000000;-37.5000000000000;-36.8750000000000;-36.2500000000000;-35.6250000000000;-35;-34.3750000000000;-33.7500000000000;-33.1250000000000;-32.5000000000000;-31.8750000000000;-31.2500000000000;-30.6250000000000;-30;-29.3750000000000;-28.7500000000000;-28.1250000000000;-27.5000000000000;-26.8750000000000;-26.2500000000000;-25.6250000000000;-25;-24.3750000000000;-23.7500000000000;-23.1250000000000;-22.5000000000000;-21.8750000000000;-21.2500000000000;-20.6250000000000;-20;-19.3750000000000;-18.7500000000000;-18.1250000000000;-17.5000000000000;-16.8750000000000;-16.2500000000000;-15.6250000000000;-15;-14.3750000000000;-13.7500000000000;-13.1250000000000;-12.5000000000000;-11.8750000000000;-11.2500000000000;-10.6250000000000;-10;-9.37500000000000;-8.75000000000000;-8.12500000000000;-7.50000000000000;-6.87500000000000;-6.25000000000000;-5.62500000000000;-5;-4.37500000000000;-3.75000000000000;-3.12500000000000;-2.50000000000000;-1.87500000000000;-1.25000000000000;-0.625000000000000;-5.92030439429403e-13;0.625000000000000;1.25000000000000;1.87500000000000;2.50000000000000;3.12500000000000;3.75000000000000;4.37500000000000;5;5.62500000000000;6.25000000000000;6.87500000000000;7.50000000000000;8.12500000000000;8.75000000000000;9.37500000000000;10;10.6250000000000;11.2500000000000;11.8750000000000;12.5000000000000;13.1250000000000;13.7500000000000;14.3750000000000;15;15.6250000000000;16.2500000000000;16.8750000000000;17.5000000000000;18.1250000000000;18.7500000000000;19.3750000000000;20;20.6250000000000;21.2500000000000;21.8750000000000;22.5000000000000;23.1250000000000;23.7500000000000;24.3750000000000;25;25.6250000000000;26.2500000000000;26.8750000000000;27.5000000000000;28.1250000000000;28.7500000000000;29.3750000000000;30;30.6250000000000;31.2500000000000;31.8750000000000;32.5000000000000;33.1250000000000;33.7500000000000;34.3750000000000;35;35.6250000000000;36.2500000000000;36.8750000000000;37.5000000000000;38.1250000000000;38.7500000000000;39.3750000000000;40;40.6250000000000;41.2500000000000;41.8750000000000;42.5000000000000;43.1250000000000;43.7500000000000;44.3750000000000;45;45.6250000000000;46.2500000000000;46.8750000000000;47.5000000000000;48.1250000000000;48.7500000000000;49.3750000000000;50;50.6250000000000;51.2500000000000;51.8750000000000;52.5000000000000;53.1250000000000;53.7500000000000;54.3750000000000;55;55.6250000000000;56.2500000000000;56.8750000000000;57.5000000000000;58.1250000000000;58.7500000000000;59.3750000000000;60;60.6250000000000;61.2500000000000;61.8750000000000;62.5000000000000;63.1250000000000;63.7500000000000;64.3750000000000;65;65.6250000000000;66.2500000000000;66.8750000000000;67.5000000000000;68.1250000000000;68.7500000000000;69.3750000000000;70;70.6250000000000;71.2500000000000;71.8750000000000;72.5000000000000;73.1250000000000;73.7500000000000;74.3750000000000;75;75.6250000000000;76.2500000000000;76.8750000000000;77.5000000000000;78.1250000000000;78.7500000000000;79.3750000000000;80;80.6250000000000;81.2500000000000;81.8750000000000;82.5000000000000;83.1250000000000;83.7500000000000;84.3750000000000;85;85.6250000000000;86.2500000000000;86.8750000000000;87.5000000000000;88.1250000000000;88.7500000000000;89.3750000000000;90;90.6250000000000;91.2500000000000;91.8750000000000;92.5000000000000;93.1250000000000;93.7500000000000;94.3750000000000;95;95.6250000000000;96.2500000000000;96.8750000000000;97.5000000000000;98.1250000000000;98.7500000000000;99.3750000000000;100;100.625000000000;101.250000000000;101.875000000000;102.500000000000;103.125000000000;103.750000000000;104.375000000000;105;105.625000000000;106.250000000000;106.875000000000;107.500000000000;108.125000000000;108.750000000000;109.375000000000;110;110.625000000000;111.250000000000;111.875000000000;112.500000000000;113.125000000000;113.750000000000;114.375000000000;115;115.625000000000;116.250000000000;116.875000000000;117.500000000000;118.125000000000;118.750000000000;119.375000000000;120;120.625000000000;121.250000000000;121.875000000000;122.500000000000;123.125000000000;123.750000000000;124.375000000000;125;125.625000000000;126.250000000000;126.875000000000;127.500000000000;128.125000000000;128.750000000000;129.375000000000;130;130.625000000000;131.250000000000;131.875000000000;132.500000000000;133.125000000000;133.750000000000;134.375000000000;135;135.625000000000;136.250000000000;136.875000000000;137.500000000000;138.125000000000;138.750000000000;139.375000000000;140;140.625000000000;141.250000000000;141.875000000000;142.500000000000;143.125000000000;143.750000000000;144.375000000000;145;145.625000000000;146.250000000000;146.875000000000;147.500000000000;148.125000000000;148.750000000000;149.375000000000;150;150.625000000000;151.250000000000;151.875000000000;152.500000000000;153.125000000000;153.750000000000;154.375000000000;155;155.625000000000;156.250000000000;156.875000000000;157.500000000000;158.125000000000;158.750000000000;159.375000000000;160;160.625000000000;161.250000000000;161.875000000000;162.500000000000;163.125000000000;163.750000000000;164.375000000000;165;165.625000000000;166.250000000000;166.875000000000;167.500000000000;168.125000000000;168.750000000000;169.375000000000;170;170.625000000000;171.250000000000;171.875000000000;172.500000000000;173.125000000000;173.750000000000;174.375000000000;175;175.625000000000;176.250000000000;176.875000000000;177.500000000000;178.125000000000;178.750000000000;179.375000000000];

%set file name logic
% each variable in MERRA2_vars must have an entry in sub_folder,
% file_middle and data_field.
% MERRA2_vars={     'albedo',           'aerosol_optical_depth',    'ozone',            'precipitable_water',   'pressure','        temperature_2m',    'relative_humidity',    'angstrom_exponent',    'aerosol_scattering'};
sub_folder={        'M2T1NXRAD',        'M2T1NXAER',                'M2I1NXASM',        'M2I1NXASM',            'M2I1NXASM',        'M2I1NXASM',        'M2I1NXASM'             'M2T1NXAER',            'M2T1NXAER'};% M2T1NXRAD, M2T1NXAER, M2I1NXASM
file_middle = {     'tavg1_2d_rad_Nx',  'tavg1_2d_aer_Nx',          'inst1_2d_asm_Nx',  'inst1_2d_asm_Nx',      'inst1_2d_asm_Nx',  'inst1_2d_asm_Nx',  'inst1_2d_asm_Nx',      'tavg1_2d_aer_Nx',      'tavg1_2d_aer_Nx'}; %tavg1_2d_rad_Nx, tavg1_2d_aer_Nx, inst1_2d_asm_Nx
data_field={        'ALBEDO',           'TOTEXTTAU',                'TO3',              'TQV',                  'PS',               'T2M',              'QV10M',                'TOTANGSTR',            'TOTSCATAU'};
% %The upper and lower permissible limits?
% c_upper=[           0.6,                0.03,                       xx,                 xx,                     xx,                 xx,                 xx,                     xx,                     xx];
% c_lower=[           0.6,                0.03,                       xx,                 xx,                     xx,                 xx,                 xx,                     xx,                     xx];
file_prefix = 'MERRA2_400.';


% loop through each variable required from MERRA2
for var=1:length(MERRA2_vars)
    % check to see whether this process needs to be performed
    if MERRA2_raw_process(var)==1
        %set the time logic in datenums and datevecs. It is a single
        %time per day for the whole year
        time_datenum_daily=datenum(num2str(years(y)),'yyyy'):datenum(num2str(years(y)+1),'yyyy')-1;
        time_datenum_hourly=datenum(num2str(years(y)),'yyyy'):1/24:datenum(num2str(years(y)+1),'yyyy')-1/24;
        time_dayvecs = datevec(time_datenum_hourly);
        %make blank array for whole year
        MERRA2_data=zeros(361,576,length(time_datenum_hourly)).*NaN;
        
        %loop through each day of the year
        for d=1:length(time_datenum_daily)
            % report to console
            disp(['Processing MERRA2: ',MERRA2_vars{var},' for ',datestr(time_datenum_daily(d))])
            
            % extract the appropriate filename
            filepath=[store.MERRA2_store,sub_folder{var},filesep,file_prefix,file_middle{var},'.',datestr(time_datenum_daily(d),'yyyymmdd'),'.nc4'];
            
            try
                %% extraction
                
                %load MERRA2 var
                % extract the appropriate data from the NetCDF file
                %get the reference file using the input date year
                evalc('nc=ncgeodataset(filepath);');
                %extract the precipitable water column data
                
                evalc(['data=nc{''',data_field{var},'''};']);
                data=double(data(:));
                
%                                 %repeat for lat, lon and time
%                                 evalc('lat=nc{''lat''};');
%                                 lat=double(lat(:));
%                                 evalc('lon=nc{''lon''};');
%                                 lon=double(lon(:));
%                                 % the time reported by MERRA is the minute number of the day at the
%                                 % start of the measurement. e.g. 0 = 00:00 - 01:00, 720 = 12:00 - 13:00
%                                 evalc('time=nc{''time''};');
%                                 time=double(time(:));
%                                 %create datenums of the time
%                                 time=time_datenum_daily(d) + time./1440;
%                                 time_dayvecs=datevec(time);
                
                %% Conversions
                % convert to DU,
                % The Dobson Unit is the most common unit for measuring ozone concentration.
                % One Dobson Unit is the number of molecules of ozone that would be required
                % to create a layer of pure ozone 0.01 millimeters thick at a temperature of
                % 0 degrees Celsius and a pressure of 1 atmosphere (the air pressure at the
                % surface of the Earth). Expressed another way, a column of air with an ozone
                % concentration of 1 Dobson Unit would contain about 2.69x1016ozone molecules
                % for every square centimeter of area at the base of the column. Over the Earth’s
                % surface, the ozone layer’s average thickness is about 300 Dobson Units or a
                % layer that is 3 millimeters thick. https://ozonewatch.gsfc.nasa.gov/facts/dobson.html
                
                  
                switch MERRA2_vars{var}
                    case 'albedo'
                        % albedo from MERRA2 is already in fractional
                        % representation of 0-1.
                        units='frac.';
                    
                    case 'aerosol_optical_depth'
                        % AOD (500nm) is a unitless variable
                        units='1';
                        
                    case 'angstrom_exponent'
                        % alpha is a unitless variable
                        units='1';
                        
                    case 'aerosol_scattering'
                        % aerosol scattering is a unitless variable
                        units='1';
                        
                    case 'ozone'
                        data=data./1000; %DU to cm
                        units='atm-cm';
                        
                    case 'pressure'
                        % pressure is natively in pascals from MERRA2. The desired
                        % unit for pressure is hPa.
                        % 100pa=1hPa
                        data=data./100;
                        units='hPa';
                        
                    case 'temperature_2m'
                        % pressure is natively in Kelvin from MERRA2. This is a
                        % satisfactory unit for temperature
                        units='K';
                        
                    case 'precipitable_water'
                        % precipitable water is in kg/m^2. The desired 
                        % format is cm-atm
                        % 1kg of water at STP = 1 litre = 1000cubic cm.
                        % 1 m^2 is 10,000cm^2, therefore 1kg water=0.1cm;
                        data=data.*0.1;
                        units='atm-cm';
                        
                    case 'relative_humidity'
                        % Relative humidity is in kg/kg from MERRA2 and is
                        % needed in units of %
                        data=data*100;
                        units='%';
                        
                end
                
                
                %                 % apply REST2 limmitations of 0<u_n<0.03 atm-cm
                %                 data(data<c_lower(var))=c_lower(var);
                %                 data(data>c_upper(var))=c_upper(var);
                
                %convert the data into more appropriate dimensions
                %(lat,lon,time), it is currently time,lat,lon);
                data2=zeros(361,576,24).*NaN;
                for ii = 1:24
                    data2(:,:,ii) = squeeze(data(ii,:,:));
                end
                data=data2;
                clear data2
            catch err%if thhe file doesn't exist or is corrupt, we cannot extract the data and so that day shall be filled with NaN values.
                % permit file open errors, as this indicates non existent
                % files or corrupt ones, neither can be managed. Other
                % errors should be logged.
                if strcmp(err.identifier,'MATLAB:imagesci:hdf5lib:fileOpenErr')
                    data=zeros(361,576,24).*NaN;
                else
                    getReport(err,'extended')
                end
            end
            
            %populate the main struct with this data
            MERRA2_data(:,:,d*24-23:d*24)=data;
        end
        
        % save the data
        filename=GetFilename(store,MERRA2_vars{var},years(y),MERRA2_prefix);
        save(filename,'MERRA2_data','-v7.3');
        % save the times
        filename=GetFilename(store,MERRA2_vars{var},years(y),MERRA2_prefix,'times_datevec');
        save(filename,'time_dayvecs','-v7.3');
        % save the one time latitudes and longitudes
        filename=GetFilename(store,MERRA2_vars{var},years(y),MERRA2_prefix,'latitudes');
        save(filename,'lats','-v7.3');
        filename=GetFilename(store,MERRA2_vars{var},years(y),MERRA2_prefix,'longitudes');
        save(filename,'lons','-v7.3');
        
        if y==(length(years)-1)
            % Make a gif of a single year
            gif_file = [store.raw_outputs_store,MERRA2_vars{var},filesep,MERRA2_prefix,'_',MERRA2_vars{var},'_',num2str(years(y)),'.gif'];
            SaveMapToGIF(gif_file,MERRA2_data,lats,lons,MERRA2_vars{var},units,time_datenum_hourly,c_upper(var),c_lower(var))
            
        end
        % clear unwanted data for space save
        clear MERRA2_data land_mask data
    end
end
end